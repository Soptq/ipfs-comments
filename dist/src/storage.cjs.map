{"version":3,"file":"storage.cjs","sources":["../../src/storage.js"],"sourcesContent":["import { Web3Storage, File } from \"web3.storage\";\nimport AES from \"crypto-js/aes.js\";\nimport Utf8 from \"crypto-js/enc-utf8.js\";\n\nimport { SimpleCache } from \"./cache.js\";\n\nclass CommentStorage {\n  constructor(appId, token, key) {\n    this.appId = appId;\n    this.client = new Web3Storage({ token: token });\n    this.key = key;\n    this.isEncrypted = !!key;\n\n    this.cache = new SimpleCache();\n  }\n\n  getDefaultRouter() {\n    return {\n      appId: this.appId,\n      router: {},\n      lastUpdated: Date.now(),\n    };\n  }\n\n  async getNameCount(name) {\n    let count = 0;\n    for await (const upload of this.client.list()) {\n      if (upload.name.startsWith(`${this.appId}/${name}`)) {\n        count++;\n      }\n    }\n\n    return count;\n  }\n\n  async getCidBetweenTimestamp(name, from, to) {\n    const cids = [];\n    for await (const upload of this.client.list()) {\n      if (upload.name.startsWith(`${this.appId}/${name}`)) {\n        const timestamp = Number(new Date(upload.created).getTime());\n        if (from < timestamp && timestamp < to) {\n          cids.push(upload.cid);\n        }\n      }\n    }\n\n    return cids;\n  }\n\n  async getLatestAppRouter() {\n    let routerExisted = false;\n    let latestTimestamp = 0;\n    let latestCid;\n    for await (const upload of this.client.list()) {\n      if (upload.name.startsWith(`${this.appId}/router`)) {\n        routerExisted = true;\n        const timestamp = Number(upload.name.split(\"/\").slice(-1)[0]);\n        if (timestamp > latestTimestamp) {\n          latestTimestamp = timestamp;\n          latestCid = upload.cid;\n        }\n      }\n    }\n\n    if (routerExisted) {\n      this.cache.set(\"router\", await this.pull(latestCid));\n    } else {\n      this.cache.set(\"router\", this.getDefaultRouter());\n      await this.push(\"router\", this.cache.get(\"router\"), Date.now());\n    }\n\n    return this.cache.get(\"router\");\n  }\n\n  async push(name, data, timestamp) {\n    const appIdAppendedName = `${this.appId}/${name}/${timestamp}`;\n    const finalizedFileContent = this.isEncrypted\n      ? AES.encrypt(JSON.stringify(data), this.key).toString()\n      : JSON.stringify(data);\n    const file = new File([finalizedFileContent], appIdAppendedName, {\n      type: \"text/plain\",\n    });\n    return await this.client.put([file], {\n      name: appIdAppendedName,\n      wrapWithDirectory: false,\n    });\n  }\n\n  async pull(cid) {\n    const res = await this.client.get(cid);\n    const file = (await res.files())[0];\n    const fileContent = Buffer.from(await file.arrayBuffer()).toString();\n    if (this.isEncrypted) {\n      const decrypted = AES.decrypt(fileContent, this.key).toString(Utf8);\n      return JSON.parse(decrypted);\n    }\n    return JSON.parse(fileContent);\n  }\n}\n\nexport { CommentStorage };\n"],"names":["Web3Storage","SimpleCache","AES","File","Utf8"],"mappings":";;;;;;;;;;;;;;AAMA,MAAM,cAAc,CAAC;AACrB,EAAE,WAAW,CAAC,KAAK,EAAE,KAAK,EAAE,GAAG,EAAE;AACjC,IAAI,IAAI,CAAC,KAAK,GAAG,KAAK,CAAC;AACvB,IAAI,IAAI,CAAC,MAAM,GAAG,IAAIA,wBAAW,CAAC,EAAE,KAAK,EAAE,KAAK,EAAE,CAAC,CAAC;AACpD,IAAI,IAAI,CAAC,GAAG,GAAG,GAAG,CAAC;AACnB,IAAI,IAAI,CAAC,WAAW,GAAG,CAAC,CAAC,GAAG,CAAC;AAC7B;AACA,IAAI,IAAI,CAAC,KAAK,GAAG,IAAIC,iBAAW,EAAE,CAAC;AACnC,GAAG;AACH;AACA,EAAE,gBAAgB,GAAG;AACrB,IAAI,OAAO;AACX,MAAM,KAAK,EAAE,IAAI,CAAC,KAAK;AACvB,MAAM,MAAM,EAAE,EAAE;AAChB,MAAM,WAAW,EAAE,IAAI,CAAC,GAAG,EAAE;AAC7B,KAAK,CAAC;AACN,GAAG;AACH;AACA,EAAE,MAAM,YAAY,CAAC,IAAI,EAAE;AAC3B,IAAI,IAAI,KAAK,GAAG,CAAC,CAAC;AAClB,IAAI,WAAW,MAAM,MAAM,IAAI,IAAI,CAAC,MAAM,CAAC,IAAI,EAAE,EAAE;AACnD,MAAM,IAAI,MAAM,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC,EAAE,IAAI,CAAC,KAAK,CAAC,CAAC,EAAE,IAAI,CAAC,CAAC,CAAC,EAAE;AAC3D,QAAQ,KAAK,EAAE,CAAC;AAChB,OAAO;AACP,KAAK;AACL;AACA,IAAI,OAAO,KAAK,CAAC;AACjB,GAAG;AACH;AACA,EAAE,MAAM,sBAAsB,CAAC,IAAI,EAAE,IAAI,EAAE,EAAE,EAAE;AAC/C,IAAI,MAAM,IAAI,GAAG,EAAE,CAAC;AACpB,IAAI,WAAW,MAAM,MAAM,IAAI,IAAI,CAAC,MAAM,CAAC,IAAI,EAAE,EAAE;AACnD,MAAM,IAAI,MAAM,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC,EAAE,IAAI,CAAC,KAAK,CAAC,CAAC,EAAE,IAAI,CAAC,CAAC,CAAC,EAAE;AAC3D,QAAQ,MAAM,SAAS,GAAG,MAAM,CAAC,IAAI,IAAI,CAAC,MAAM,CAAC,OAAO,CAAC,CAAC,OAAO,EAAE,CAAC,CAAC;AACrE,QAAQ,IAAI,IAAI,GAAG,SAAS,IAAI,SAAS,GAAG,EAAE,EAAE;AAChD,UAAU,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC;AAChC,SAAS;AACT,OAAO;AACP,KAAK;AACL;AACA,IAAI,OAAO,IAAI,CAAC;AAChB,GAAG;AACH;AACA,EAAE,MAAM,kBAAkB,GAAG;AAC7B,IAAI,IAAI,aAAa,GAAG,KAAK,CAAC;AAC9B,IAAI,IAAI,eAAe,GAAG,CAAC,CAAC;AAC5B,IAAI,IAAI,SAAS,CAAC;AAClB,IAAI,WAAW,MAAM,MAAM,IAAI,IAAI,CAAC,MAAM,CAAC,IAAI,EAAE,EAAE;AACnD,MAAM,IAAI,MAAM,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC,EAAE,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC,EAAE;AAC1D,QAAQ,aAAa,GAAG,IAAI,CAAC;AAC7B,QAAQ,MAAM,SAAS,GAAG,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;AACtE,QAAQ,IAAI,SAAS,GAAG,eAAe,EAAE;AACzC,UAAU,eAAe,GAAG,SAAS,CAAC;AACtC,UAAU,SAAS,GAAG,MAAM,CAAC,GAAG,CAAC;AACjC,SAAS;AACT,OAAO;AACP,KAAK;AACL;AACA,IAAI,IAAI,aAAa,EAAE;AACvB,MAAM,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,QAAQ,EAAE,MAAM,IAAI,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC,CAAC;AAC3D,KAAK,MAAM;AACX,MAAM,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,QAAQ,EAAE,IAAI,CAAC,gBAAgB,EAAE,CAAC,CAAC;AACxD,MAAM,MAAM,IAAI,CAAC,IAAI,CAAC,QAAQ,EAAE,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,QAAQ,CAAC,EAAE,IAAI,CAAC,GAAG,EAAE,CAAC,CAAC;AACtE,KAAK;AACL;AACA,IAAI,OAAO,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;AACpC,GAAG;AACH;AACA,EAAE,MAAM,IAAI,CAAC,IAAI,EAAE,IAAI,EAAE,SAAS,EAAE;AACpC,IAAI,MAAM,iBAAiB,GAAG,CAAC,EAAE,IAAI,CAAC,KAAK,CAAC,CAAC,EAAE,IAAI,CAAC,CAAC,EAAE,SAAS,CAAC,CAAC,CAAC;AACnE,IAAI,MAAM,oBAAoB,GAAG,IAAI,CAAC,WAAW;AACjD,QAAQC,uBAAG,CAAC,OAAO,CAAC,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,EAAE,IAAI,CAAC,GAAG,CAAC,CAAC,QAAQ,EAAE;AAC9D,QAAQ,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,CAAC;AAC7B,IAAI,MAAM,IAAI,GAAG,IAAIC,iBAAI,CAAC,CAAC,oBAAoB,CAAC,EAAE,iBAAiB,EAAE;AACrE,MAAM,IAAI,EAAE,YAAY;AACxB,KAAK,CAAC,CAAC;AACP,IAAI,OAAO,MAAM,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,EAAE;AACzC,MAAM,IAAI,EAAE,iBAAiB;AAC7B,MAAM,iBAAiB,EAAE,KAAK;AAC9B,KAAK,CAAC,CAAC;AACP,GAAG;AACH;AACA,EAAE,MAAM,IAAI,CAAC,GAAG,EAAE;AAClB,IAAI,MAAM,GAAG,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;AAC3C,IAAI,MAAM,IAAI,GAAG,CAAC,MAAM,GAAG,CAAC,KAAK,EAAE,EAAE,CAAC,CAAC,CAAC;AACxC,IAAI,MAAM,WAAW,GAAG,MAAM,CAAC,IAAI,CAAC,MAAM,IAAI,CAAC,WAAW,EAAE,CAAC,CAAC,QAAQ,EAAE,CAAC;AACzE,IAAI,IAAI,IAAI,CAAC,WAAW,EAAE;AAC1B,MAAM,MAAM,SAAS,GAAGD,uBAAG,CAAC,OAAO,CAAC,WAAW,EAAE,IAAI,CAAC,GAAG,CAAC,CAAC,QAAQ,CAACE,wBAAI,CAAC,CAAC;AAC1E,MAAM,OAAO,IAAI,CAAC,KAAK,CAAC,SAAS,CAAC,CAAC;AACnC,KAAK;AACL,IAAI,OAAO,IAAI,CAAC,KAAK,CAAC,WAAW,CAAC,CAAC;AACnC,GAAG;AACH;;;;"}